<script>
  window.onload = () => {
    const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_PUBLIC_ANON_KEY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) showApp();
      else showAuth();
    });

    function showApp() {
      document.getElementById('auth-section').style.display = 'none';
      document.getElementById('app-section').style.display = 'block';
    }

    function showAuth() {
      document.getElementById('auth-section').style.display = 'block';
      document.getElementById('app-section').style.display = 'none';
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      console.log('Login response:', { data, error });
      if (error) return alert('Login error: ' + error.message);
      alert('Login successful');
      showApp();
    }

    async function signup() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { data, error } = await supabase.auth.signUp({ email, password });
      console.log('Signup response:', { data, error });
      if (error) return alert('Signup error: ' + error.message);
      alert('Signup successful, check your email to confirm.');
    }

    async function logout() {
      await supabase.auth.signOut();
      showAuth();
    }

    async function generateUniqueNumber() {
      const { data, error } = await supabase.from('birth_cert_requests').select('number');
      if (error) throw error;
      const existing = new Set(data.map(row => row.number));
      let number;
      do {
        number = String(Math.floor(10000 + Math.random() * 90000));
      } while (existing.has(number));
      return number;
    }

    async function submitData() {
      const name = document.getElementById('name').value.trim();
      const notes = document.getElementById('notes').value.trim();

      const number = await generateUniqueNumber();
      const { data, error } = await supabase.from('birth_cert_requests').select('*').eq('number', number);

      let status = \"in progress\";
      if (data && data.length > 0) {
        const choices = [\"approved\", \"rejected\", \"missing docs\"];
        status = prompt(\"This number exists. Enter new status (approved, rejected, missing docs):\", choices[0]);
        if (!choices.includes(status)) {
          alert(\"Invalid status\");
          return;
        }
      }

      const { data: insertData, error: insertError } = await supabase.from('birth_cert_requests').upsert({
        number,
        status,
        notes: notes || null,
        timestamp: new Date().toISOString(),
      }, { onConflict: ['number'] });

      if (insertError) {
        alert('Error submitting data: ' + insertError.message);
        return;
      }

      const latest = insertData[0];
      document.getElementById('result').innerHTML = `
        <strong>Name:</strong> ${name}<br/>
        <strong>Number:</strong> ${latest.number}<br/>
        <strong>Status:</strong> ${latest.status}<br/>
        <strong>Notes:</strong> ${latest.notes || \"None\"}<br/>
        <strong>Timestamp:</strong> ${latest.timestamp}<br/>
        <strong>ID:</strong> ${latest.id || \"N/A\"}<br/>
      `;
    }

    // Attach handlers globally for button clicks
    window.login = login;
    window.signup = signup;
    window.logout = logout;
    window.submitData = submitData;
  };
</script>
